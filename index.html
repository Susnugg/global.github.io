<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Chat</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212;
            color: #E0E0E0;
        }
        .main-content {
            display: flex;
            height: calc(100vh - 1rem);
            gap: 1rem;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            transition: width 0.3s ease-in-out;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a4a4a #1f1f1f;
        }
        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: #4a4a4a;
            border-radius: 10px;
        }
        .chat-messages::-webkit-scrollbar-track {
            background-color: #1f1f1f;
        }
        .message-bubble {
            animation: message-fade-in-up 0.8s ease-out;
        }
        .message-input-container {
            display: flex;
            padding: 1rem;
            background-color: #1f1f1f;
        }
        .changelog-sidebar {
            width: 0;
            overflow: hidden;
            transition: width 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            background-color: #1f1f1f;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
        }
        .changelog-sidebar.visible {
            width: 30%;
            padding: 1rem;
        }
        .changelog-content {
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a4a4a #1f1f1f;
        }
        @keyframes message-fade-in-up {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        /* Plain grey border for all messages */
        .member-border {
            position: relative;
            z-index: 1;
        }
        .member-border::before {
            content: '';
            position: absolute;
            inset: -2px;
            border-radius: 0.75rem;
            background-color: #A0A0A0; /* Plain grey border */
            z-index: -1;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full transition-all duration-300 transform scale-95">
            <h2 id="auth-title" class="text-2xl font-bold text-center mb-6 text-teal-400">Set Your Username</h2>
            <form id="auth-form" class="space-y-4">
                <input type="text" id="auth-username-input" placeholder="Username" class="w-full p-3 bg-gray-700 text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200" required />
                <button type="submit" id="auth-submit-button" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl transition duration-200">Save</button>
            </form>
            <p id="auth-status" class="text-center text-sm text-gray-400 mt-4">Signing in...</p>
        </div>
    </div>
    
    <!-- Main Content Area with Chat and Changelog -->
    <div id="main-content-area" class="main-content rounded-xl shadow-2xl max-w-6xl mx-auto transition-shadow duration-300 hidden">
        <!-- Main Chat Interface -->
        <div id="chat-app" class="chat-container bg-gray-900">
            
            <!-- Header -->
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h1 id="chat-header" class="text-2xl font-bold text-teal-400">Online Global Chat</h1>
                <div class="flex space-x-2">
                    <button id="changelog-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200">Changelog</button>
                    <button id="groups-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200">My Groups</button>
                    <button id="logout-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200">Logout</button>
                </div>
            </div>

            <!-- Messages Display Area -->
            <div id="messages-container" class="chat-messages p-4 space-y-4">
                <!-- Messages will be injected here by JavaScript -->
            </div>

            <!-- User Info & Input Area -->
            <div class="p-4 border-t border-gray-700 bg-gray-900">
                <div id="user-info" class="text-sm text-gray-400 mb-2">
                    Connecting...
                </div>
                
                <!-- Message Input -->
                <div class="message-input-container space-x-2 rounded-xl">
                    <input type="text" id="message-input" placeholder="Type your message..." class="flex-grow p-3 bg-gray-800 text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition duration-200" autocomplete="off" />
                    <button id="send-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-xl transition duration-200">Send</button>
                </div>
            </div>
        </div>

        <!-- Changelog Sidebar -->
        <div id="changelog-sidebar" class="changelog-sidebar">
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-purple-400">Changelog</h2>
            </div>
            <div id="changelog-list" class="changelog-content p-4 space-y-4">
                <!-- Changelog entries will be injected here -->
            </div>
            <!-- Changelog Input & Button Container -->
            <div id="changelog-input-container" class="p-4 border-t border-gray-700 bg-gray-900 hidden">
                <input type="text" id="changelog-input" placeholder="Add a new entry..." class="w-full p-3 bg-gray-800 text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200" autocomplete="off" />
                <button id="add-changelog-button" class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl transition duration-200">Add Entry</button>
            </div>
        </div>
    </div>


    <!-- Groups Modal -->
    <div id="groups-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full transition-all duration-300 transform scale-95">
            <h2 class="text-2xl font-bold text-center mb-6 text-blue-400">My Groups</h2>
            
            <div id="user-groups-list" class="space-y-4 max-h-60 overflow-y-auto mb-6">
                <!-- Groups will be listed here -->
            </div>

            <div class="space-y-4">
                <button id="create-group-button" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition duration-200">Create New Group</button>
                <div id="create-group-section" class="hidden">
                    <input type="text" id="new-group-name" placeholder="Group Name" class="w-full p-3 mb-2 bg-gray-700 text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-green-500" />
                    <button id="submit-create-group" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition duration-200">Create</button>
                </div>

                <div class="relative flex items-center py-5">
                    <div class="flex-grow border-t border-gray-600"></div>
                    <span class="flex-shrink mx-4 text-gray-400">or</span>
                    <div class="flex-grow border-t border-gray-600"></div>
                </div>

                <div id="join-group-section">
                    <input type="text" id="join-group-code" placeholder="Join Code" class="w-full p-3 mb-2 bg-gray-700 text-white rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500" />
                    <button id="submit-join-group" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl transition duration-200">Join Group</button>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button id="close-groups-modal" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-xl transition duration-200">Close</button>
            </div>
        </div>
    </div>

    <!-- Members Modal -->
    <div id="members-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-sm w-full transition-all duration-300 transform scale-95">
            <h2 class="text-2xl font-bold text-center mb-6 text-orange-400">Group Members</h2>
            <div id="group-members-list" class="space-y-4 max-h-60 overflow-y-auto mb-6">
                <!-- Members will be listed here -->
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-members-modal" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-xl transition duration-200">Close</button>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Alerts -->
    <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50 transition-all duration-300">
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg max-w-sm w-full border border-gray-700 transition-all duration-300">
            <div id="modal-content">
                <div class="text-white text-lg font-semibold mb-4" id="modal-message"></div>
                <div id="modal-actions" class="flex justify-end space-x-2">
                    <button id="modal-cancel-button" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-xl transition duration-200 hidden">Cancel</button>
                    <button id="modal-close-button" class="bg-teal-500 hover:bg-teal-600 text-white py-2 px-4 rounded-xl transition duration-200">OK</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, getDoc, doc, setDoc, where, updateDoc, arrayUnion, arrayRemove, getDocs, setLogLevel, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Use the global variables provided by the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('debug'); // Enable debug logging for Firestore

        // --- DOM Elements ---
        const mainContentArea = document.getElementById('main-content-area');
        const messagesContainer = document.getElementById('messages-container');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userInfoDiv = document.getElementById('user-info');
        const customModal = document.getElementById('custom-modal');
        const chatApp = document.getElementById('chat-app');
        const authModal = document.getElementById('auth-modal');
        const authTitle = document.getElementById('auth-title');
        const authForm = document.getElementById('auth-form');
        const authUsernameInput = document.getElementById('auth-username-input');
        const authSubmitButton = document.getElementById('auth-submit-button');
        const authStatus = document.getElementById('auth-status');
        const logoutButton = document.getElementById('logout-button');
        const chatHeader = document.getElementById('chat-header');
        const groupsButton = document.getElementById('groups-button');
        const membersButton = document.createElement('button');
        membersButton.id = 'members-button';
        membersButton.className = 'bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200 ml-2 hidden';
        membersButton.textContent = 'Members';
        const deleteGroupButton = document.createElement('button');
        deleteGroupButton.id = 'delete-group-button';
        deleteGroupButton.className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl transition duration-200 ml-2 hidden';
        deleteGroupButton.textContent = 'Delete Group';
        document.querySelector('.flex.space-x-2').prepend(deleteGroupButton);
        document.querySelector('.flex.space-x-2').prepend(membersButton);

        const changelogButton = document.getElementById('changelog-button');
        const changelogSidebar = document.getElementById('changelog-sidebar');
        const changelogList = document.getElementById('changelog-list');
        const changelogInput = document.getElementById('changelog-input');
        const addChangelogButton = document.getElementById('add-changelog-button');
        const changelogInputContainer = document.getElementById('changelog-input-container');

        const groupsModal = document.getElementById('groups-modal');
        const closeGroupsModalButton = document.getElementById('close-groups-modal');
        const createGroupButton = document.getElementById('create-group-button');
        const createGroupSection = document.getElementById('create-group-section');
        const newGroupNameInput = document.getElementById('new-group-name');
        const submitCreateGroupButton = document.getElementById('submit-create-group');
        const joinGroupCodeInput = document.getElementById('join-group-code');
        const submitJoinGroupButton = document.getElementById('submit-join-group');
        const userGroupsList = document.getElementById('user-groups-list');
        const membersModal = document.getElementById('members-modal');
        const closeMembersModalButton = document.getElementById('close-members-modal');
        const groupMembersList = document.getElementById('group-members-list');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const modalCloseButton = document.getElementById('modal-close-button');


        // --- Firebase & User State ---
        let db, auth;
        let userId = null;
        let username = 'Guest';
        let currentChatMode = 'global'; // 'global', 'private' or 'group'
        let currentChatId = null; // Holds the privateChatPartnerId or groupId
        let currentChatName = null;
        let currentGroupCreatorId = null;
        let unsubscribe = null; // Variable to hold the unsubscribe function
        let changelogUnsubscribe = null;

        // --- Modal Control Functions ---
        const showModal = (message, onConfirm, showCancel = false) => {
            customModal.classList.remove('hidden');
            customModal.querySelector('#modal-message').textContent = message;
            modalCloseButton.textContent = showCancel ? 'Confirm' : 'OK';
            modalCancelButton.classList.toggle('hidden', !showCancel);

            modalCloseButton.onclick = () => {
                customModal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };

            modalCancelButton.onclick = () => {
                customModal.classList.add('hidden');
            };
        };

        // --- Firebase & App Initialization ---
        const initFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Set up auth state change listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Setup message listener immediately
                        setupRealtimeListener();
                        setupChangelogListener();
                        
                        // Check if user profile exists
                        const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/profile/info`);
                        try {
                            const userDocSnap = await getDoc(userDocRef);
                            
                            if (userDocSnap.exists()) {
                                username = userDocSnap.data().username;
                                authModal.classList.add('hidden');
                                mainContentArea.classList.remove('hidden');
                                updateUserInfo();
                                
                                // Check if user can edit changelog and show/hide the input container
                                console.log('Checking username:', username, 'for changelog permissions.');
                                if (username && username.toLowerCase() === 'susnugg') {
                                    changelogInputContainer.classList.remove('hidden');
                                } else {
                                    changelogInputContainer.classList.add('hidden');
                                }
                                
                            } else {
                                // New user: show username creation modal
                                username = 'Guest';
                                authModal.classList.remove('hidden');
                                authTitle.textContent = "Welcome! Set your Username";
                                authStatus.textContent = "Please choose a username to continue.";
                                authForm.classList.remove('hidden');
                                mainContentArea.classList.remove('hidden'); // Show app while they create a username
                                updateUserInfo();
                            }
                        } catch (error) {
                            console.error("Error fetching user profile:", error);
                            showModal("Could not load user profile. Please try again later.");
                        }
                    } else {
                        userId = null;
                        username = 'Guest';
                        updateUserInfo();
                        mainContentArea.classList.add('hidden');
                    }
                });
                
                // Initial sign-in with the custom token or anonymously
                try {
                    if (authToken) {
                        await signInWithCustomToken(auth, authToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showModal(`Authentication failed. Please check your network or refresh the page. (Error: ${error.code})`);
                }

            } catch (error) {
                console.error("Error initializing Firebase services:", error);
                showModal("Could not connect to the database. Please check your configuration and refresh the page.");
            }
        };

        // Update the user info display
        const updateUserInfo = () => {
            if (userId) {
                userInfoDiv.textContent = `Logged in as: ${username}`;
            } else {
                userInfoDiv.textContent = `Not logged in`;
            }
        };

        const getDmId = (user1Id, user2Id) => {
            return user1Id < user2Id ? `${user1Id}_${user2Id}` : `${user2Id}_${user1Id}`;
        };

        const startPrivateChat = (targetUserId, targetUsername) => {
            if (targetUserId === userId) {
                showModal("You cannot DM yourself.");
                return;
            }
            currentChatMode = 'private';
            currentChatId = getDmId(userId, targetUserId);
            currentChatName = `DM with: ${targetUsername}`;
            currentGroupCreatorId = null;
            messagesContainer.innerHTML = '';
            updateChatHeader();
            setupRealtimeListener();
        };

        const startGroupChat = (groupId, groupName, creatorId) => {
            currentChatMode = 'group';
            currentChatId = groupId;
            currentChatName = `Group: ${groupName}`;
            currentGroupCreatorId = creatorId;
            messagesContainer.innerHTML = '';
            updateChatHeader();
            setupRealtimeListener();
        };

        const updateChatHeader = () => {
            chatHeader.innerHTML = `
                ${currentChatName || 'Online Global Chat'}
                <button id="back-to-global-button" class="bg-gray-600 hover:bg-gray-700 text-white text-sm py-1 px-3 ml-4 rounded-xl transition duration-200">
                    Back to Global Chat
                </button>
            `;
            if (currentChatMode !== 'global') {
                document.getElementById('back-to-global-button').addEventListener('click', () => {
                    currentChatMode = 'global';
                    currentChatId = null;
                    currentChatName = null;
                    currentGroupCreatorId = null;
                    messagesContainer.innerHTML = '';
                    updateChatHeader();
                    setupRealtimeListener();
                });
            }

            if (currentChatMode === 'group') {
                membersButton.classList.remove('hidden');
                if (userId === currentGroupCreatorId) {
                    deleteGroupButton.classList.remove('hidden');
                } else {
                    deleteGroupButton.classList.add('hidden');
                }
            } else {
                membersButton.classList.add('hidden');
                deleteGroupButton.classList.add('hidden');
            }
        };


        // Setup the real-time listener for chat messages
        const setupRealtimeListener = () => {
            // Unsubscribe from any previous listener
            if (unsubscribe) {
                unsubscribe();
            }

            if (!db || !userId) {
                console.log("DB or user not ready, skipping message listener setup.");
                return;
            }
            
            let collectionPath;
            if (currentChatMode === 'global') {
                collectionPath = `/artifacts/${appId}/public/data/chat_messages`;
            } else if (currentChatMode === 'private') {
                collectionPath = `/artifacts/${appId}/public/data/private_dms/${currentChatId}/messages`;
            } else if (currentChatMode === 'group') {
                collectionPath = `/artifacts/${appId}/public/data/group_chats/${currentChatId}/messages`;
            } else {
                return; // Should not happen
            }
            console.log("Listening to collection:", collectionPath);

            const messagesRef = collection(db, collectionPath);
            // Removed orderBy('timestamp') to avoid potential index-related permission issues
            const messagesQuery = query(messagesRef);

            unsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                // Clear the container before re-rendering
                messagesContainer.innerHTML = '';
                
                // Sort documents by timestamp in JavaScript
                const sortedMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => a.timestamp - b.timestamp);

                sortedMessages.forEach(message => {
                    const messageElement = document.createElement('div');
                        
                    const isCurrentUser = message.userId === userId;
                    const alignmentClass = isCurrentUser ? 'ml-auto' : 'mr-auto';
                    const bubbleColor = isCurrentUser ? 'bg-teal-700' : 'bg-gray-700';
                    const textColor = isCurrentUser ? 'text-white' : 'text-gray-200';
                    const flexAlignment = isCurrentUser ? 'justify-end' : 'justify-start';
                    const displayName = isCurrentUser ? 'You' : (message.username || 'Member');
                    
                    const borderClass = 'member-border';
                    const nicknameClass = 'font-bold text-white cursor-pointer';

                    messageElement.className = `flex ${flexAlignment} mb-2 message-bubble animate-fadeInUp`;
                    messageElement.innerHTML = `
                        <div class="p-3 max-w-[80%] rounded-xl ${alignmentClass} ${bubbleColor} ${textColor} ${borderClass} break-words shadow-md transition-all duration-300">
                            <span class="text-xs block mb-1 ${nicknameClass}"
                                data-user-id="${message.userId}"
                                data-username="${message.username}">
                                ${displayName}
                            </span>
                            <span>${message.text}</span>
                        </div>
                    `;
                    messagesContainer.appendChild(messageElement);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Add event listener to the nickname of each message
                messagesContainer.querySelectorAll('span.font-bold').forEach(nicknameEl => {
                    nicknameEl.addEventListener('click', (event) => {
                        const targetUserId = event.target.dataset.userId;
                        const targetUsername = event.target.dataset.username;
                        startPrivateChat(targetUserId, targetUsername);
                    });
                });
            }, (error) => {
                console.error("Error fetching messages:", error);
                // The error is most likely due to permission issues.
                showModal(`Failed to load messages due to insufficient permissions. Please check your Firestore security rules. Error: ${error.message}`);
            });
        };

        const setupChangelogListener = () => {
            if (changelogUnsubscribe) {
                changelogUnsubscribe();
            }

            if (!db) {
                console.log("DB not ready, skipping changelog listener setup.");
                return;
            }

            const changelogRef = collection(db, `/artifacts/${appId}/public/data/changelog`);
            const q = query(changelogRef);
            changelogUnsubscribe = onSnapshot(q, (snapshot) => {
                changelogList.innerHTML = '';
                const sortedLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => b.timestamp - a.timestamp); // Sort descending

                sortedLogs.forEach(log => {
                    const logElement = document.createElement('div');
                    logElement.className = "p-3 bg-gray-700 rounded-xl mb-2 text-sm";
                    const formattedDate = log.timestamp ? new Date(log.timestamp.toDate()).toLocaleString() : 'Just now';
                    logElement.innerHTML = `<span class="font-bold">${log.username}:</span> ${log.text}<br><span class="text-xs text-gray-400">${formattedDate}</span>`;
                    changelogList.appendChild(logElement);
                });
            }, (error) => {
                console.error("Error fetching changelog:", error);
                // Similar to the chat, this is likely a permission issue.
                showModal(`Failed to load changelog due to insufficient permissions. Please check your Firestore security rules. Error: ${error.message}`);
            });
        };

        // Function to send a message
        const sendMessage = async () => {
            const messageText = messageInput.value.trim();
            if (messageText === "" || !db || !userId) {
                return;
            }

            try {
                let collectionPath;
                if (currentChatMode === 'global') {
                    collectionPath = `/artifacts/${appId}/public/data/chat_messages`;
                } else if (currentChatMode === 'private') {
                    collectionPath = `/artifacts/${appId}/public/data/private_dms/${currentChatId}/messages`;
                } else if (currentChatMode === 'group') {
                    collectionPath = `/artifacts/${appId}/public/data/group_chats/${currentChatId}/messages`;
                } else {
                    return; // Should not happen
                }

                await addDoc(collection(db, collectionPath), {
                    userId: userId,
                    username: username,
                    text: messageText,
                    timestamp: serverTimestamp(),
                });
                
                messageInput.value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal("Failed to send message. Please try again.");
            }
        };

        const generateJoinCode = () => {
            return Math.random().toString(36).substring(2, 8).toUpperCase();
        };

        const createGroup = async () => {
            const groupName = newGroupNameInput.value.trim();
            if (!groupName) {
                showModal("Please enter a name for the group.");
                return;
            }
            try {
                const joinCode = generateJoinCode();
                const newGroupRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/group_chats`), {
                    name: groupName,
                    creatorId: userId,
                    joinCode: joinCode,
                    members: [userId],
                    createdAt: serverTimestamp()
                });

                showModal(`Group "${groupName}" created! Share this join code: ${joinCode}`);
                groupsModal.classList.add('hidden');
                startGroupChat(newGroupRef.id, groupName, userId);
            } catch (e) {
                console.error("Error creating group:", e);
                showModal("Failed to create group. Please try again.");
            }
        };

        const joinGroup = async () => {
            const joinCode = joinGroupCodeInput.value.trim().toUpperCase();
            if (!joinCode) {
                showModal("Please enter a join code.");
                return;
            }
            try {
                const groupsRef = collection(db, `/artifacts/${appId}/public/data/group_chats`);
                const q = query(groupsRef, where("joinCode", "==", joinCode));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showModal("Invalid join code. Please try again.");
                    return;
                }

                const groupDoc = querySnapshot.docs[0];
                const groupId = groupDoc.id;
                const groupData = groupDoc.data();
                const members = groupData.members || [];

                if (members.includes(userId)) {
                    showModal(`You are already a member of "${groupData.name}".`);
                    groupsModal.classList.add('hidden');
                    startGroupChat(groupId, groupData.name, groupData.creatorId);
                    return;
                }

                showModal(`Attempting to join "${groupData.name}"...`);

                // Add user to the members array and wait for it to complete
                await updateDoc(doc(db, `/artifacts/${appId}/public/data/group_chats/${groupId}`), {
                    members: arrayUnion(userId)
                });
                
                // Fetch the updated document directly to ensure client-side data is synchronized.
                const updatedGroupDocSnap = await getDoc(doc(db, `/artifacts/${appId}/public/data/group_chats/${groupId}`));
                const updatedGroupData = updatedGroupDocSnap.data();

                showModal(`You have joined the group "${updatedGroupData.name}"!`);
                groupsModal.classList.add('hidden');
                startGroupChat(groupId, updatedGroupData.name, updatedGroupData.creatorId);
            } catch (e) {
                console.error("Error joining group:", e);
                showModal("Failed to join group. Please try again.");
            }
        };

        const deleteGroup = async () => {
            if (!currentChatId || currentChatMode !== 'group' || userId !== currentGroupCreatorId) {
                showModal("You can only delete groups that you created.");
                return;
            }

            showModal(`Are you sure you want to delete "${currentChatName}"? This action cannot be undone.`, async () => {
                try {
                    // Start a new batch to perform multiple writes atomically
                    const batch = writeBatch(db);
                    
                    // Delete all messages in the group's subcollection
                    const messagesRef = collection(db, `/artifacts/${appId}/public/data/group_chats/${currentChatId}/messages`);
                    const querySnapshot = await getDocs(messagesRef);
                    querySnapshot.forEach(messageDoc => {
                        batch.delete(messageDoc.ref);
                    });
                    
                    // Delete the main group document
                    const groupDocRef = doc(db, `/artifacts/${appId}/public/data/group_chats/${currentChatId}`);
                    batch.delete(groupDocRef);
                    
                    // Commit the batch
                    await batch.commit();
                    
                    showModal(`Group "${currentChatName}" has been deleted.`);
                    currentChatMode = 'global';
                    currentChatId = null;
                    currentChatName = null;
                    currentGroupCreatorId = null;
                    messagesContainer.innerHTML = '';
                    updateChatHeader();
                    setupRealtimeListener();
                } catch (e) {
                    console.error("Error deleting group:", e);
                    let errorMessage = "Failed to delete group. This is likely due to insufficient Firestore security rules. Please ensure your rules allow you to delete both the group document and all documents within its 'messages' subcollection.";
                    showModal(errorMessage);
                }
            }, true); // The 'true' parameter enables the cancel button
        };

        const setupGroupListener = () => {
            if (unsubscribe) {
                unsubscribe();
            }
            const groupsRef = collection(db, `/artifacts/${appId}/public/data/group_chats`);
            const q = query(groupsRef, where("members", "array-contains", userId));

            unsubscribe = onSnapshot(q, (snapshot) => {
                userGroupsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const group = doc.data();
                    const groupElement = document.createElement('div');
                    groupElement.className = "p-3 bg-gray-700 rounded-xl cursor-pointer hover:bg-gray-600 transition-colors";
                    groupElement.textContent = group.name;
                    groupElement.addEventListener('click', () => {
                        startGroupChat(doc.id, group.name, group.creatorId);
                        groupsModal.classList.add('hidden');
                    });
                    userGroupsList.appendChild(groupElement);
                });
            }, (error) => {
                console.error("Error fetching groups:", error);
            });
        };

        const showMembersModal = async () => {
            if (!currentChatId || currentChatMode !== 'group') {
                showModal("This feature is only available for group chats.");
                return;
            }

            groupMembersList.innerHTML = 'Loading members...';
            membersModal.classList.remove('hidden');

            try {
                const groupDocRef = doc(db, `/artifacts/${appId}/public/data/group_chats/${currentChatId}`);
                const groupDocSnap = await getDoc(groupDocRef);
                
                if (!groupDocSnap.exists()) {
                    showModal("Group not found.");
                    return;
                }
                
                const groupData = groupDocSnap.data();
                const members = groupData.members || [];
                groupMembersList.innerHTML = '';

                for (const memberId of members) {
                    const memberDocRef = doc(db, `/artifacts/${appId}/users/${memberId}/profile/info`);
                    const memberDocSnap = await getDoc(memberDocRef);
                    const memberUsername = memberDocSnap.exists() ? memberDocSnap.data().username : 'Unknown User';

                    const memberElement = document.createElement('div');
                    memberElement.className = 'flex justify-between items-center p-3 bg-gray-700 rounded-xl';
                    
                    const memberNameSpan = document.createElement('span');
                    memberNameSpan.textContent = memberUsername;
                    memberElement.appendChild(memberNameSpan);

                    // Add a remove button for the group creator
                    if (userId === groupData.creatorId && memberId !== userId) {
                        const removeButton = document.createElement('button');
                        removeButton.textContent = 'Remove';
                        removeButton.className = 'bg-red-600 hover:bg-red-700 text-white py-1 px-3 rounded-xl transition duration-200';
                        removeButton.onclick = () => removeGroupMember(memberId, memberUsername);
                        memberElement.appendChild(removeButton);
                    }
                    groupMembersList.appendChild(memberElement);
                }
            } catch (e) {
                console.error("Error fetching group members:", e);
                showModal("Failed to load group members. Please try again.");
            }
        };

        const removeGroupMember = async (memberId, memberUsername) => {
            showModal(`Are you sure you want to remove ${memberUsername} from the group?`, async () => {
                try {
                    await updateDoc(doc(db, `/artifacts/${appId}/public/data/group_chats/${currentChatId}`), {
                        members: arrayRemove(memberId)
                    });
                    showModal(`${memberUsername} has been removed.`);
                    showMembersModal(); // Refresh the members list
                } catch (e) {
                    console.error("Error removing member:", e);
                    showModal("Failed to remove member. This is likely due to insufficient permissions. Please check your security rules.");
                }
            }, true);
        };

        // --- Event Listeners ---
        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newUsername = authUsernameInput.value.trim();
            if (newUsername === "") {
                showModal("Username cannot be empty.");
                return;
            }
            try {
                // Save the new username to the user's profile
                const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/profile/info`);
                await setDoc(userDocRef, {
                    username: newUsername,
                    createdAt: serverTimestamp()
                });
                // Update local username state
                username = newUsername;
                
                authModal.classList.add('hidden');
                mainContentArea.classList.remove('hidden');
                updateUserInfo();
            } catch (error) {
                console.error("Error saving username:", error);
                showModal("Failed to save username. Please try again.");
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout error:", error);
                showModal("Failed to log out.");
            }
        });

        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        changelogButton.addEventListener('click', () => {
            changelogSidebar.classList.toggle('visible');
        });

        addChangelogButton.addEventListener('click', async () => {
            const entryText = changelogInput.value.trim();
            if (entryText === "" || !db || !userId) {
                return;
            }
            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/changelog`), {
                    text: entryText,
                    username: username,
                    timestamp: serverTimestamp(),
                });
                changelogInput.value = '';
            } catch (e) {
                console.error("Error adding changelog entry: ", e);
                showModal("Failed to add changelog entry. Check your permissions.");
            }
        });

        groupsButton.addEventListener('click', () => {
            groupsModal.classList.remove('hidden');
            setupGroupListener();
        });

        closeGroupsModalButton.addEventListener('click', () => {
            groupsModal.classList.add('hidden');
        });

        createGroupButton.addEventListener('click', () => {
            createGroupSection.classList.toggle('hidden');
        });

        submitCreateGroupButton.addEventListener('click', createGroup);
        submitJoinGroupButton.addEventListener('click', joinGroup);

        membersButton.addEventListener('click', showMembersModal);
        closeMembersModalButton.addEventListener('click', () => {
            membersModal.classList.add('hidden');
        });

        deleteGroupButton.addEventListener('click', deleteGroup);

        // Start the application
        window.onload = () => {
            initFirebase();
        };
    </script>
</body>
</html>
